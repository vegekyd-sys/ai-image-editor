# Makaron — AI 修图产品 PRD

> 版本：v0.6（2026-02-20）
> 当前线上地址：https://ai-image-editor-ochre-zeta.vercel.app

---

## 一、产品定位

### 核心价值主张

**Makaron 让任何人都能把普通照片变成让人"哇"一声的作品。**

不需要懂 Photoshop，不需要会写 prompt，只需要上传一张图，AI 就会理解这张照片的内容、情绪和氛围，主动给出 6 条有针对性的编辑建议——每条都是专门为这张图设计的，不是通用模板。

### 差异化定位

| 对比维度 | 传统修图工具 | AI 美颜 App | Makaron |
|---------|------------|------------|---------|
| 目标用户 | 专业摄影师 | 自拍用户 | 所有拍照记录生活的人 |
| 操作门槛 | 高（需要专业知识） | 低（但功能单一） | 极低（AI 主动出建议） |
| 输出效果 | 可预期 | 千篇一律 | 惊喜感、故事性 |
| 核心体验 | 工具感 | 滤镜感 | "哇，没想到可以这样" |

### 产品理念

- **加法而非替换**：高质量的编辑是往画面加入小元素，保持 80%+ 原图不变，而不是大幅替换场景
- **有故事感**：每个创意建议必须能一句话说清楚"因为这张图有 X，所以 Y 才合适"
- **视觉冲击力**：enhance 效果必须 3 秒内肉眼可见，太微妙的变化等于没有

---

## 二、目标用户

### 主要用户画像

**"爱拍照但不会修图"的普通用户**
- 用手机拍了很多照片（亲子、旅行、美食、日常）
- 知道图片可以更好，但不知道具体怎么改
- 没有时间和精力学 Lightroom/PS
- 希望发朋友圈的时候照片能让人多看两眼

### 使用场景

1. **亲子照片**：妈妈拍了孩子和自己的日常，想让照片更温馨、更有故事感
2. **旅行纪念**：出游的风景人像照，想要"电影感"或者"好玩的创意"
3. **美食记录**：餐厅或厨房场景，想加入有趣的元素让食物"活起来"
4. **日常分享**：想发朋友圈但觉得照片平平无奇，需要一点"点睛之笔"

---

## 三、核心功能规格

### 3.1 项目管理

**项目列表页（/projects）**
- 展示用户所有历史项目，按时间倒序排列
- 每个项目展示封面缩略图 + 编辑版本数（v1/v2...）
- 点击进入编辑器，查看完整编辑历史
- 「+」按钮：上传新图片创建项目
- 项目支持重命名、删除

**数据持久化**
- 所有项目、快照（snapshot）、聊天记录持久化到 Supabase
- 关闭 App 重新进入，历史编辑和对话完整恢复
- 所有持久化操作异步后台执行，不阻塞 UI

### 3.2 编辑器核心体验

#### GUI 模式（图片画布模式）

**图片时间轴（Timeline）**
- 每次编辑产生一个 snapshot，形成左右滑动的时间轴
- 滑动切换查看不同版本
- 长按当前图片：before/after 对比原图
- 编辑中的 draft 以虚拟节点方式展示（不正式入轴）

**TipsBar（编辑建议栏）**
- 底部横向卡片滚动，展示 6 条 AI 建议
- 每张卡片：emoji + 标题 + 描述 + 缩略图预览
- **两步交互模式**：
  - 第一次点击 → 生成预览（Draft），看效果
  - 点击「继续编辑」→ Commit（正式保存为新版本，加载新一轮 6 条建议）
- 无预览的 tip（`none` 状态）：点击立即触发生成，有进度提示
- 长按 tip → 对比原图和预览效果

**三类建议**

| 类别 | 定义 | 典型效果 |
|------|------|---------|
| **enhance（专业增强）** | 光影/色彩/质感整体提升，必须 3 秒内肉眼可见 | 电影感光影、黄金时刻、阴天变晴天、强景深分离 |
| **creative（趣味创意）** | 往画面加入与内容有因果关系的有趣新元素 | 柴犬偷看热可可、书页飞出童话角色、活鸭围观烤鸭 |
| **wild（疯狂脑洞）** | 让画面中已有物品发生夸张变形 | 菜单页漫天飞舞、热可可变巨型喷泉、救生衣极速膨胀 |

**预览图生成策略**
- 首次上传：自动生成全部 6 张预览图
- Commit 后再次生成：只自动生成 1 enhance + 1 wild（节省时间和成本）
- CUI 编辑后：只生成文字建议，不自动生成预览图（用户手动点击触发）

**AgentStatusBar（状态栏）**
- 常驻底部，显示 AI 当前状态/打招呼文字
- 整行可点击进入 CUI
- Draft 状态下显示：「喜欢这个效果？你想怎么修改告诉我 👉🏻」
- 生成中显示：「正使用nano banana pro生成图片 x/y」
- Chat 按钮：点击进入 CUI 模式

#### CUI 模式（全屏对话模式）

**对话界面**
- 全屏覆盖，从右侧滑入，右滑退出
- Claude App 风格：assistant 消息无气泡，用户消息深色 pill
- PiP 缩略图（右下角）：显示当前正在编辑的图片，点击循环切换三种尺寸（72/116/200px）
- 内联图片显示：AI 生成的图片直接展示在对话流中

**多轮对话编辑**
- 用户可描述任何修改需求，AI 理解意图后生成图片
- 对话历史保留最近 30 条（适配 1M context 模型）
- AI 拥有原图参考能力：生成图片时同时传入原图 + 当前版本，Claude 在 editPrompt 中明确引用原图做人脸保真参考
- 当用户说"人脸变了"时，AI 会使用原图作为人脸 reference 重新生成

**多轮对话策略**
- 明确需求（如"加蝴蝶在肩上"）→ 直接生成
- 模糊需求（如"变好看"）→ 基于图片分析直接生成
- 复杂/不清晰需求 → 先问一轮再生图
- 人脸/人物投诉（如"人脸变了"）→ 以原图为参考重新生成，不盲目 retry
- 需求符合现有 tip → 推荐 TipsBar 里对应的 tip，让用户自行决定

**输入框**
- 多行 textarea，随输入内容自动扩高
- Enter 发送，Shift+Enter 换行
- AI 分析过程中可以输入，但不能发送

### 3.3 认证与账户

- **登录方式**：Google OAuth + Magic Link（邮件链接登录）
- 登录后直接进入项目列表
- 所有数据按用户隔离（Supabase RLS 保护）

---

## 四、用户核心路径

### 路径 A：首次使用（新用户）

```
打开 App
→ 登录（Google 或邮件）
→ 项目列表页（空状态）
→ 点击 「+」 → 选择相册图片
→ 进入编辑器
→ 等待 ~10s → 6 条建议出现（文字先出，预览图逐渐生成）
→ 点击感兴趣的建议 → 查看预览效果
→ 点击「继续编辑」→ 确认此版本，进入新一轮编辑
→ 重复或通过 Chat 精细调整
→ 「Save」保存到相册
```

### 路径 B：用 Chat 精细调整

```
在 GUI 看到一个 enhance 效果
→ 整体不错但人脸有点变样
→ 点击 StatusBar 进入 CUI
→ 说「人脸有点变了，能跟原来一样吗？」
→ AI 以原图为人脸参考重新生成
→ 效果满意 → 返回 GUI → 点「继续编辑」confirm
```

### 路径 C：快速浏览历史

```
再次打开 App
→ 项目列表，看到历史项目封面
→ 点击进入
→ 滑动时间轴查看所有版本
→ 长按对比 before/after
→ 继续编辑或直接保存
```

---

## 五、AI 能力规格

### Tips 生成

- **模型**：Claude Sonnet 4.5（AWS Bedrock）
- **速度**：~10s 出现全部 6 条文字建议（3 个并行 category 调用）
- **策略**：`.md` 模板文件（enhance.md/creative.md/wild.md）为唯一规则来源
- **质量目标**：≥8 分（10 分制）占比 ≥70%，均分 ≥7.5

### 图片生成（预览/编辑）

- **模型**：Gemini 3 Pro Image Preview（via OpenRouter）
- **输入分辨率**：最高 2048px（客户端压缩后）
- **输出分辨率**：~2048px（跟随输入）
- **多图参考**：有原图时，同时传入原图 + 当前版本给 Gemini
- **人脸保真规则**（已验证硬结论）：
  - 只允许"eyes glance slightly + eyebrows raise tiny amount"
  - 禁止任何嘴型变化（必崩脸）
  - 小脸（<10% 画面）禁止任何面部处理，只用身体语言反应
  - jawline 条件瘦脸：只对有明显下颌线的成年人做 V-line，儿童/圆脸跳过

### Agent（Makaron）

- **模型**：Claude Sonnet 4.5（AWS Bedrock）
- **工具**：`generate_image`（调 Gemini 生图）、`analyze_image`（Claude 原生视觉）
- **多轮上下文**：最近 30 条对话（user + assistant）
- **原图参考**：每次生图时传入 snapshots[0]（原图）作为 reference

---

## 六、技术架构概览

### 前端

- **框架**：Next.js 16（App Router）
- **语言**：TypeScript
- **样式**：Tailwind CSS，深色主题（黑底 + fuchsia/red accent）
- **移动端优先**：touch swipe、safe area、no-zoom viewport

### 后端（API Routes）

| 路由 | 功能 |
|------|------|
| `POST /api/tips` | SSE 流式输出 6 条 tips，Claude Sonnet 生成 |
| `POST /api/agent` | SSE 流式 agent 对话，支持多种 mode |
| `POST /api/preview` | 单次图片编辑生成，Gemini |
| `POST /api/upload` | HEIC→JPEG 转换 + Sharp 压缩 |

### AI 层

```
用户图片
    ↓
Claude Sonnet (Bedrock) ← Tips 文字生成
    ↓
editPrompt (English)
    ↓
Gemini 3 Pro Image (OpenRouter) ← 图片生成/编辑
    ↓
编辑后图片
```

### 数据层

- **认证**：Supabase Auth（Google OAuth + Magic Link）
- **存储**：Supabase Storage（`images` bucket，公开读）
- **数据库**：Supabase PostgreSQL（projects / snapshots / messages，全 RLS）
- **持久化策略**：所有写入 fire-and-forget，不阻塞 UI

### 部署

- **平台**：Vercel
- **环境变量**：`OPENROUTER_API_KEY`、`AWS_*`（Bedrock）、`SUPABASE_*`

---

## 七、当前状态与指标

### Tips 质量（V42，最新）

| 指标 | 数值 |
|------|------|
| 均分 | 7.3 / 10 |
| ≥8 分占比 | 70% |
| enhance 均分 | 7.2 |
| creative 均分 | 7.4 |
| wild 均分 | 7.2 |
| 历史最高均分 | 8.03（V34） |

### 速度

| 环节 | 当前耗时 |
|------|---------|
| 第一条 tip 文字出现 | ~10s |
| 全部 6 条 tip 文字 | ~12s |
| 单张预览图生成 | ~25-35s |
| 全部 6 张预览图 | ~60-90s（并发 3） |

### 已知问题与限制

| 问题 | 严重程度 | 状态 |
|------|---------|------|
| Agent 多图人脸保真不稳定（有时有效有时无效） | 高 | 待调查 |
| Wild 眼镜相关 idea 仍会出现（禁止方向突破） | 中 | 已记录 |
| Enhance 方向F（天气改造）有时重新生成人物 | 中 | 已记录 |
| Tips 速度目标 5s 未达到（当前 10s） | 中 | 进行中 |

---

## 八、待开发功能（Backlog）

### P0（近期）

1. **Tips 速度优化到 5s**：考虑 Claude Haiku 或 A3 两阶段（先出 label/desc，后台补 editPrompt）
2. **Agent 人脸保真稳定性**：深入调查 Gemini 多图参考机制，探索 subject_preservation 参数
3. **Kling 视频生成接入**：将用户的 snapshot timeline 连成几秒视频，让照片"动起来"

### P1（中期）

4. **自适应 Tips 推荐**：根据用户点击历史和聊天内容，动态调整 enhance/creative/wild 的推荐比例
   - 修图导向用户 → 多推 enhance
   - 娱乐导向用户 → 多推 creative/wild
5. **Wild Q4 执行可行性拦截**：透明材质、复杂几何变形等高失败率方向的自动过滤
6. **分享功能**：生成前后对比图，一键分享到社交媒体

### P2（长期）

7. **视频支持**：短视频的片段智能截帧 + 编辑
8. **批量编辑**：对相册中同一场景的多张照片批量应用同一风格

---

## 九、设计规范

### 视觉风格

- **主色调**：黑色背景（`#080808`）+ fuchsia 亮色（`#c026d3` / `#e879f9`）
- **暗色玻璃感**：UI 元素用 `rgba(255,255,255,0.08)` 层叠，backdrop-blur
- **动效**：spring 弹簧动画（`cubic-bezier(0.34, 1.56, 0.64, 1)`），节点呼吸动画
- **字体大小**：移动端标准（最小 11px，输入框 21px）

### 交互原则

- **零延迟原则**：所有持久化操作异步后台执行，UI 不等待服务器
- **渐进显示**：tips 文字先出、预览图逐渐加载，不等全部完成再展示
- **移动端优先**：40px touch target，safe area insets，单手操作

---

## 十、核心 Tips Prompt 方法论（已验证）

这是最重要的产品内容资产，通过 40+ 轮实验验证得出：

### 高分公式
**通透感 + 人物轮廓保真 + 前后景深变化 + 自然色调 = WOW（10 分）**

### Enhance 高分方向（稳定 8 分）
A. 电影感光影 | B. 黄金时刻 | C. 阴天变晴天 | D. 夜景/傍晚氛围 | E. 强景深分离 | F. 天气改造 | G. 净化场景

### Creative 成功公式
「因为画面里有 [具体物品X]，所以加一个 [元素Y] 正在 [有趣动作Z]」
- X = 画面中具体可见的东西（食物/衣服/地标），不是场景类型
- Y = 跟 X 有直接因果关系
- Z = 元素自己在做的有趣行为（不是"看着人/站着"）

### Wild 高分方向（优先顺序）
C. 死物活化（10分）> D. 功能极端化（10分）> A. 尺寸极端化（8分）> B. 材质变化（8分）

### 绝对禁止（验证为低分）
- 梯田/层状物 → 蛋糕/食物（3分，纯形状类比）
- 眼镜反射/投射内容（3分，太小看不出）
- 修改眼睛大小/形状（导致面部重新生成）
- 风格化重绘（如工笔画、吉卜力）除非场景极度匹配
- enhance 变化太微妙（"看不出变化"= 3 分）
